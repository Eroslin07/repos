<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newtouch.uctp.module.business.dal.mysql.CarInfoMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->
    <resultMap id="appCarInfoRespVO" type="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppCarInfoRespVO">
        <id property="id" column="id"/>
        <result property="vin" column="vin"/>
        <result property="brand" column="brand"/>
        <result property="year" column="year"/>
        <result property="model" column="model"/>
        <result property="engineNum" column="engineNum"/>
        <result property="vehicleReceiptAmount" column="vehicleReceiptAmount"/>
        <result property="remarks" column="remarks"/>
        <result property="salesStatus" column="salesStatus"/>
        <result property="status" column="status"/>
        <result property="firstParty" column="firstParty"/>
        <result property="secondParty" column="secondParty"/>
    </resultMap>

    <sql id="appPageColumn">
        a.ID as id,
        a.BRAND as brand,
        a.VIN as vin,
        a.YEAR as year,
        a.MODEL as model,
        a.ENGINE_NUM as engineNum,
        a.VEHICLE_RECEIPT_AMOUNT as vehicleReceiptAmount,
        a.SALES_STATUS as salesStatus,
        a.STATUS as status,
        a.STATUS_THREE as statusThree,
        b.MILEAGE as mileage,
        b.BUYER_NAME as firstParty,
        b.SELLER_NAME as secondParty
    </sql>


    <select id="selectAppHomePage"
            resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppHomeCarInfoRespVO">
        select
            <include refid="appPageColumn" />
        from uctp_car_info a
        inner join uctp_car_info_details b on a.id = b.CAR_ID
        <where>
            a.BUSINESS_ID = #{pageVO.businessId}
            <if test="pageVO.searchValue != null and pageVO.searchValue != ''">
                <bind name="pageVO.searchValue" value="'%'+pageVO.searchValue+'%'"/>
                and (a.VIN like #{pageVO.searchValue}
                or a.BRAND like #{pageVO.searchValue}
                or a.BUYER_NAME like #{pageVO.searchValue}
                or a.SELLER_NAME like #{pageVO.searchValue})
            </if>
            <if test="pageVO.status != null">
                and a.STATUS = #{pageVO.status}
            </if>
            <if test="pageVO.statusThree != null">
                and a.STATUS_THREE = #{pageVO.statusThree}
            </if>
        </where>
        order by a.CREATE_TIME desc
    </select>
<!--    这里需要关联文件表查询车头的图片，如果查不出来就一个个的去查-->
    <select id="selectAppCellCarPage"
            resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppSellCarInfoPageRespVO">
        select
            <include refid="appPageColumn" />
        from uctp_car_info a
        inner join uctp_car_info_details b on a.id = b.CAR_ID
        <where>
            a.BUSINESS_ID = #{pageVO.businessId}
            <if test="pageVO.searchValue != null and pageVO.searchValue != ''">
                <bind name="pageVO.searchValue" value="'%'+pageVO.searchValue+'%'"/>
                and (a.VIN like #{pageVO.searchValue}
                or a.BRAND like #{pageVO.searchValue}
                or a.BUYER_NAME like #{pageVO.searchValue}
                or a.SELLER_NAME like #{pageVO.searchValue})
            </if>
            <if test="pageVO.salesStatus != null">
                and a.SALES_STATUS = #{pageVO.salesStatus}
            </if>
            <if test="pageVO.status != null">
                and a.STATUS = #{pageVO.status}
            </if>
            <if test="pageVO.statusThree != null and pageVO.statusThree.length > 0">
                and a.STATUS_THREE in
                <foreach collection="pageVO.statusThree" item="item"
                         index="index" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
        order by a.CREATE_TIME desc
    </select>




    <select id="getCarInfoAndDetails" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppCarInfoAndDetailVO">
     select
              uci.id,
              uci.BRAND,
              uci.YEAR,
              uci.MODEL,
              ucid.MILEAGE,
              uci.VIN,
              uci.CREATE_TIME as createTime,
              ucid.CERTIFICATE_NO as certificateNo,
              ucid.DRIVING_lICENSE as drivingLicense,
              uci.SALES_STATUS as salesStatus,
              uci.CHECK_STATUS as checkStatus,
              DATEDIFF(CURDATE(), uci.CREATE_TIME) inStockTime,
              ucid.pay_type as payType,
              ucid.remit_type as remitType,
              ucid.FIRST_REGIST_DATE as firsRegistration,
              ucid.FIRST_REGIST_DATE as firstRegistDate,
              uci.CREATOR as operator,
              ENGINE_NUM as engineNum,
              SELLER_ID_CARD as sellerIdCard,
              SELLER_NAME as sellerName,
              SELLER_TEL as sellerTel,
              collection,
              THIRD_SELLER_NAME as thirdSellerName,
              REMIT_TYPE as remitType,
              THIRD_BANK_CARD as thirdBankCard,
              BUYER_ID_CARD as buyerIdCard,
              BUYER_NAME as buyerName,
              BUYER_TEL buyerTel
      from uctp_car_info uci left join uctp_car_info_details ucid
      on uci.ID =ucid.CAR_ID
      where uci.id=#{id}
    </select>

    <select id="getPeopelInfo" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.PeopleVo">
        select
            SELLER_ID_CARD as sellerIdCard,
            SELLER_NAME as sellerName,
            SELLER_TEL as sellerTel,
            collection,
            THIRD_SELLER_NAME as thirdSellerName,
            REMIT_TYPE as remitType,
            THIRD_BANK_CARD as thirdBankCard,
            BUYER_ID_CARD as buyerIdCard,
            BUYER_NAME as buyerName,
            BUYER_TEL buyerTel
        from uctp_car_info_details
        where CAR_ID =#{carID}
    </select>

 <select id="getCarDCDetails" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.PicResp">
     select


              ucid.FIRST_REGIST_DATE as firstRegistDate,

              ENGINE_NUM as engineNum
      from  uctp_car_info_details ucid

      where ucid.CAR_ID=#{id}
    </select>

    <select id="getCarCosts" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppCarCostVO">
        select
            MAIN_ID as mainID,
            VEHICLE_RECEIPT_AMOUNT  as vehicleReceiptAmount,
            TESTING_FEE as testingFee,
            OPERATION_FEE as operationFee,
            TRANSFER_FEE as transferFee,
            TAXATION ,
            OTHER_TAXATION as otherTaxation,
            CAR_SALES_AMOUNT as carSalesAmount,
            PROFIT,
            case when PAY_TYPE='1' then '支付成功' when PAY_TYPE='0' then '支付失败' else '' end payType,
            (IFNULL(VEHICLE_RECEIPT_AMOUNT,0)+IFNULL(TESTING_FEE+OPERATION_FEE,0)+IFNULL(TRANSFER_FEE+TAXATION,0)+IFNULL(OTHER_TAXATION,0) ) costCount
        from uctp_cost_detail
        where MAIN_ID=#{id}
    </select>



    <select id="getContractInfo" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppContractarVO">
        select
            ucm.CAR_ID as carID,
            ucm.NUMBER as contractID,
            ucm.NAME as contractName,
            ucm.CONTRACT_TYPE as contractType,
            ucm.STATUS ,
            ucid.collection
        from uctp_contract_management ucm left join uctp_car_info_details ucid
        on ucid.CAR_ID =ucm.CAR_ID
        where ucm.CAR_ID=#{carID}
    </select>

    <select id="getContractInfo" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppCarInvoiceVo">
        select
            uim.id invoiceId,
            uim.INVOICE_TYPE as invoiceType,
            uim.status,
            uim.CONTRACT_NO as contractNo,
            uim.name,
            uim.AMOUNT_MONEY amountMoney,
            tax
        from uctp_car_info uci inner join uctp_contract_management ucm  on uci.ID =ucm.CAR_ID
        inner join uctp_invoices_management uim on uim.CONTRACT_NO =ucm.`NUMBER`
        where uci.ID =#{id}
    </select>

    <update id="updateContractStatas" parameterType="map">
        update
            uctp_contract_management set STATUS='2'
        where NUMBER=#{vo.contractID}
    </update>

    <select id="getInvoicesInfo" resultType="com.newtouch.uctp.module.business.dal.dataobject.InvoicesInfoDO">

        select
            id,
            INVOICE_TYPE as invoiceType,
            BUSINESS as business,
            NAME ,
            AMOUNT_MONEY as amountMoney,
            TAX ,
            STATUS,
            TENANT_ID as tenantId,
            CREATED_BY as reatedBy,
            CREATED_TIME as createdTime,
            UPDATED_BY as updatedBy,
            UPDATED_TIME as updatedTime
        from uctp_invoices_management uim where id =#{id}
    </select>

    <select id="getInvoicesInfo" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.AppCarInvoiceVo">
       select
            uim.id invoiceId,
            uim.INVOICE_TYPE as invoiceType,
            uim.business,
            uim.status,
            uim.CONTRACT_NO as contractNo,
            uim.name,
            uim.AMOUNT_MONEY amountMoney,
            uim.tax,
            uim.CREATED_BY as createdBy,
            uim.CREATED_TIME as createdTime,
            uim.UPDATED_BY as updatedBy,
            uim.UPDATED_TIME as updatedTime
        from uctp_car_info uci inner join uctp_contract_management ucm  on uci.ID =ucm.CAR_ID
        inner join uctp_invoices_management uim on uim.CONTRACT_NO =ucm.`NUMBER`
        where uci.ID =#{id}
    </select>

    <select id="getCarDC"  resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">

     select
     	DRIVING_lICENSE as drivingLicense,
     	CERTIFICATE_NO as certificateNo

     from
     uctp_car_info_details
      where CAR_ID =#{carID}

    </select>

    <select id="getCarIds" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">

     select
     	ubf.id as longId
     from
     uctp_car_info_details ucid inner join uctp_business_file ubf
     on ucid.CAR_ID =ubf.MAIN_ID

     where CAR_ID =#{carID}

    </select>

    <select id="getDrivingLicenseIds" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">

     select
     	ubf.id as longId
     from
     uctp_car_info_details ucid inner join uctp_business_file ubf
     on ucid.DRIVING_lICENSE =ubf.MAIN_ID

     where CAR_ID =#{carID}

    </select>

    <select id="getCertificateIds" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">


    select
     	ubf.id as longId
     from
     uctp_car_info_details ucid inner join uctp_business_file ubf
     on ucid.CERTIFICATE_NO =ubf.MAIN_ID
     where CAR_ID =#{carID}
    </select>

    <select id="getContractIds" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">


    select
     	ubf.id as longId,
     	ucm.number as contractID
     from uctp_contract_management ucm inner join uctp_business_file ubf
     on ucm.NUMBER =ubf.MAIN_ID
     where ucm.NUMBER =#{contractID}
    </select>

    <select id="getInvoiceIds" resultType="com.newtouch.uctp.module.business.controller.app.carInfo.vo.CarDCVo">
        select
        	ubf.id as longId,
        from uctp_invoices_management uim inner join uctp_business_file ubf
        on uim.id =ubf.MAIN_ID
        where uim.id =#{id}
    </select>




</mapper>